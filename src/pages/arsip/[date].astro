---
import Layout from '../../layouts/Layout.astro';
import peopleData from '../../data/people.json';
import { generateMatchups } from '../../utils/game-logic';
import { z } from 'zod';

export const prerender = false;

const paramsSchema = z.object({ date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/) });

let date: string;
try {
  ({ date } = paramsSchema.parse(Astro.params));
} catch (error) {
  date = '';
}

const requested = date ? new Date(date) : null;
const today = new Date();
const isValid = !!date && !!requested && !Number.isNaN(requested.valueOf()) && requested <= today;
const matchups = isValid ? generateMatchups(peopleData, date) : [];
const title = isValid ? `Archive ${date} | Who’s Older?` : 'Archive date not found';
const description = isValid
  ? `Replay the duels and fun facts that appeared on ${requested!.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}.`
  : 'Archive date is unavailable or invalid.';
---

<Layout title={title} description={description} canonical={`${Astro.url.origin}/arsip/${date}`}>
  <main class="max-w-5xl mx-auto p-6 sm:p-8">
    <div class="bg-slate-900/70 border border-slate-800 rounded-3xl p-6 sm:p-8 shadow-2xl space-y-6">
      {isValid ? (
        <>
          <header class="space-y-2">
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400 font-bold">Archive</p>
            <h1 class="text-4xl font-black text-white">Challenge {date}</h1>
            <p class="text-slate-300">Duels shown on this date, with birth years and short fun facts.</p>
          </header>

          <section class="space-y-4">
            {matchups.map((m, idx) => (
              <article class="p-4 sm:p-5 rounded-2xl border border-slate-800 bg-slate-900/60 shadow-lg" aria-label={`Duel ${idx + 1}`}>
                <div class="text-[11px] uppercase tracking-[0.25em] text-slate-400 mb-3 font-bold">Duel {idx + 1} · {m.difficulty.toUpperCase()}</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {[m.personA, m.personB].map((person) => (
                    <div class="flex items-start space-x-3">
                      <img src={`/api/image/${person.id}`} alt={person.name} width="80" height="80" loading="lazy" decoding="async" class="w-20 h-20 rounded-2xl object-cover border border-slate-800" />
                      <div class="space-y-1">
                        <div class="font-semibold text-white">{person.name}</div>
                        {person.occupation && <div class="text-xs uppercase tracking-wide text-slate-400">{person.occupation}</div>}
                        <div class="text-sm text-sky-300 font-mono">Born {person.birthYear}</div>
                        {person.funFact && <div class="text-sm text-slate-200">{person.funFact}</div>}
                      </div>
                    </div>
                  ))}
                </div>
              </article>
            ))}
          </section>
        </>
      ) : (
        <div class="p-6 rounded-2xl bg-rose-900/30 border border-rose-700 text-rose-100">
          Archive date is unavailable or not yet published.
        </div>
      )}

      <div class="pt-4 flex justify-between text-sm text-sky-300">
        <a href="/" class="hover:text-white font-semibold">Play today’s challenge</a>
        <a href="/arsip" class="hover:text-white font-semibold">Back to archive</a>
      </div>
    </div>
  </main>
</Layout>
